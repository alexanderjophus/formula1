name: push

on:
  push:
    branches: [ main ]

jobs:
  unit-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.21

      - name: Test backend
        run: cd formulagraphql && go test -v ./...

  build-publish:
    runs-on: ubuntu-latest
    needs: [ unit-test ]
    steps:
      # checkout code
      - uses: actions/checkout@v2
      # build model, build binary
      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.21

      # docker login and push
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push (formulagraphql)
        uses: docker/build-push-action@v2
        with:
          context: ./formulagraphql
          push: true
          tags: ghcr.io/alexanderjophus/formulagraphql:latest
          file: formulagraphql/Dockerfile

  deploy-graphql:
    runs-on: ubuntu-latest
    needs: [ build-publish ]
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - uses: 'actions/checkout@v3'

    - id: 'auth'
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'

    - id: 'deploy'
      uses: 'google-github-actions/deploy-cloudrun@v1'
      with:
        service: 'grapqhl-service'
        image: 'gghcr.io/alexanderjophus/formulagraphql:latest'

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [ unit-test ]
    steps:
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          target: wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@v1
      - name: Install CLI
        run: cargo install dioxus-cli --locked
      - uses: actions/checkout@v2
      - name: Build
        run: cd web && dx build --release && cargo run --release
      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4.2.3
        with:
          branch: gh-pages # The branch the action should deploy to.
          folder: site # The folder the action should deploy.
          target-folder: .
          clean: false # don't scrub site